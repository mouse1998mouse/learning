# ZAB协议
Zookeeper 是基于ZAB 协议实现，ZAB协议是一个简化版的paxos。它的出现主要用来解决分布式系统下数据一致性的问题。

### Zookeeper具备的特性
Zookeeper用一个单一的主进程来接收并处理客户端的所有事物请求，并采用ZAB原子广播协议将服务器数据状态以事物proposal的形式广播到所有副本进程中。这样子的模式就保证了，在同一时刻只有一个主进程来广播服务器的状态变更，因此能够很好的处理客户端大量的并发请求，这就叫==消息广播==。


>所有的事务请求必须由一个全局唯一的服务器来协调处理，这样的服务器叫：Leader 服务器。其他的服务器被称为 Follower 服务器。Leader 服务器将客户端事务请求转化成一个事务 Prososal（提议），并将改 Proposal 分发给集群中所有的 Follower 服务器。之后 Leader 服务器接收了正确的反馈后，那么 Leader 就会再次向所有的 Follower 服务器分发 Commit 消息，要求将前一个 Proposal 提交。

#### ZAB中的消息广播
会发生活动选举的情况：
1. 当服务器启动时期会进行 Leader 选举。
2. 当服务器运行期 Leader服务器的出现网络中断、奔溃退出、重启等异常情况，或者当集群中半数的服务器与该 Leader 服务器无法通信时，进入崩溃恢复模式，开始 Leader 选举。

**选举出leader服务器后，就会进入消息广播模式**
leader: 整个集群的核心，事务请求的唯一调度和处理者，保证事务的顺序性。集群内部服务器的调度者。
Follower：处理客户端非事务请求，并转发给leader服务器；参与事务请求的Proposal投票；参与leader选举投票。
Observer：是 zookeeper 自 3.3.0 开始引入的一个角色，它不参与事务请求 Proposal 的投票，也不参与 Leader 选举投票，只提供非事务的服务（查询），通常在不影响集群事务处理能力的前提下提升集群的非事务处理能力。


状态有三种：leader选举状态、同步状态、作为leader状态。

##### 事务ID（ZXID）
Leader 服务器在接收到事务请求后，会为每个事务请求生成对应的 Proposal 来进行广播，并且在广播事务 Proposal 之前，Leader 服务器会首先为这个事务 Proposal 分配一个全局单调递增的唯一 ID ，我们称之为==事务 ID（即 ZXID）。==
其中ZXID的高32位代表周期（确定领导地位），低32位代表计数器（针对客户端的每个事务请求都会进行加 1 操作）。

消息广播的具体细节：
- Leader 服务器接收到请求后在进行广播事务 Proposal 之前会为这个事务分配一个 ZXID，再进行广播。
- Leader 服务器会为每个 Follower 服务器都各自分配一个单独的队列，然后将需要广播的事务 Proposal 依次放入这些队列中去，并根据 FIFO 策略进行消息的发送。
- 每个Follower 服务器在接收到后都会将其以事务日志的形式写入到本地磁盘中，并且在成功写入后返回 Leader 服务器一个 ACK 响应。
- 当有超过半数的服务器 ACK 响应后，Leader 就会广播一个 Commit 消息给所有的 Follower 服务器，Follower 接收到后就完成对事务的提交操作。
- 

#### 崩溃恢复
其实就是在leader崩溃时，选择一个新的leader，然后再去同步leader服务器。ZAB协议对于不同阶段出现的数据不一致性情况作出了兼容，保证了：
- 在leader上==提交==的数据，最终会被所有服务器提交
- 只在leader提出的事务，会被丢弃